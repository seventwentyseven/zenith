{% extends 'base.html' %}
{% block title %}Relationships{% endblock %}

{% block header %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/timeago.js/2.0.2/timeago.min.js" integrity="sha512-sl01o/gVwybF1FNzqO4NDRDNPJDupfN0o2+tMm4K2/nr35FjGlxlvXZ6kK6faa9zhXbnfLIXioHnExuwJdlTMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/translucent.css"/>
{% endblock %}


{% block content %}
<div class="w-10/12 max-w-screen-xl my-12 mx-auto flex flex-col bg-hsl-20 rounded-lg" id="top-box">
    <div class="h-14 bg-hsl-25 rounded-t-lg flex items-center">
        <span class="text-xl font-light ml-6" id="type-name">Friends</span>
        <div class="ml-auto mr-6 flex items-center text-lg" id="type-btns">
            <button class="mx-0.5 h-10 w-10 rounded hover:bg-hsl-15
                hover:text-hsl-90 transition duration-150"
                id="btn-friend" onclick="switchType('friend')">
                <i class="fas fa-user-friends"></i>
            </button>
            <button class="mx-0.5 h-10 w-10 rounded hover:bg-hsl-15
                hover:text-hsl-90 transition duration-150"
                id="btn-block" onclick="switchType('block')">
                <i class="fas fa-ban"></i>
            </button>
            {% if supporer %}
            <button class="mx-0.5 h-10 w-10 rounded hover:bg-hsl-15
                hover:text-hsl-90 transition duration-150"
                id="btn-followers" onclick="switchType('followers')">
                <i class="fas fa-eye"></i>
            </button>
            {% endif %}
        </div>
    </div>
    <div class="m-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2" id="the-box"></div>
    <div class="flex justify-center" id="load-more">
        <button class=" my-2 py-1.5 px-3 text-sm font-light bg-hsl-10
            hover:bg-hsl-15 transition duration-200 rounded"
            id="btn-loadmore" onclick="loadMore()">
            Load more
        </button>
    </div>
</div>
{% endblock %}

{% block bottom %}
<style>
    .badge-bg {
        background-color: hsla(var(--main), 10%, 10%, 0.8);
    }
</style>
<script>
    type = 'friend';
    offset = 0;
    // Fetch data from /wapi/get_friends?type=friends
    function loadRelations(type, offset) {
        axios.get(`/wapi/get_friends?t=${type}&o=${offset}`)
        .then((r) => {
            if (r.data.result.length == 0) {
                document.getElementById('the-box').innerHTML = `
                    <div class="w-full h-28 col-span-1 md:col-span-2 lg:col-span-3 flex items-center justify-center">
                        <span class="text-3xl font-light">No results : /</span>
                    </div>`
                document.getElementById('load-more').remove();
            } else if (r.data.result.length < 24) {
                document.getElementById('load-more').remove();
            }

            for (el of r.data.result) {
                badges = ``
                for (b of el.priv) {
                    badges += `
                    <div class="rounded-full py-1 px-2 badge-bg ${b[1]} mr-1">
                        ${b[0]}
                    </div>`
                }
                if (el.online) {
                    online = `
                        <div class="h-2 w-2 bg-green-600 rounded-full mr-1.5"></div>
                        <span>Online</span>
                        `
                } else {
                    online = `
                        <div class="h-2 w-2 bg-gray-400 rounded-full mr-1.5"></div>
                        <span>Offline, Last seen ${timeago().format(el.latest_activity*1000)}</span>
                    `
                }
                document.getElementById('the-box').innerHTML += `
                <div class="col-span-1 row-span-1 bg-hsl-25 rounded-lg h-28 transition duration-300"
                    style="background: linear-gradient(hsl(var(--main), 10%, 10%, 0.7),
                    hsl(var(--main), 10%, 10%, 0.7)), url(https://{{ domain() }}/banners/${el.id});
                    background-position: center; background-size: cover;"
                    id="fren-${el.id}">
                    <div class="m-3 flex flex-col justify-between">
                        <!-- User info -->
                        <div class="flex h-2/3">
                            <!-- Avatar -->
                            <img class="h-14 w-14 rounded-lg shadow-md"
                                src="https://a.{{ domain() }}/${el.id}">
                            <div class="flex flex-col justify-between ml-2">
                                <!-- Flag and uname -->
                                <div class="h-6/12 flex items-center">
                                    <img class="w-8 h-5 mr-2"
                                        src="/static/images/flags/${el.country.toUpperCase()}.png">
                                    <span class="text-lg font-medium">${el.name}</span>
                                </div>
                                <!-- Group badges -->
                                <div class="h-5/12 flex text-xs">
                                    ${badges}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-end text-sm h-1/3 mt-4">
                            <div class="flex flex-row items-center">
                                ${online}
                            </div>
                        </div>
                    </div>
                </div>
                `
            }
        })
    }

    function reAddTippy() {
        // Add tippy to buttons
            tippy('#btn-friend', {
                content: "Your friends",
                theme: 'translucent'
            });
            tippy('#btn-block', {
                content: "Your blocked users",
                theme: 'translucent'
            });
            tippy('#btn-followers', {
                content: "People that added you as friend",
                theme: 'translucent'
            });
    }

    function switchType(ltype) {
        document.getElementById('the-box').innerHTML = ``
        offset = 0;
        type = ltype;
        loadRelations(ltype, offset);

        // Switch reset style of buttons in type-btn
        for (btn of document.getElementById('type-btns').children) {
            btn.classList.remove('bg-hsl-15', 'text-hsl-90');
        }
        // Add style to the selected button
        document.getElementById(`btn-${ltype}`).classList.add('bg-hsl-15', 'text-hsl-90');

        if (type == 'friend') {
            document.getElementById('type-name').innerHTML = 'Friends';
        } else if (type == 'block') {
            document.getElementById('type-name').innerHTML = 'Blocked';
        } else if (type == 'followers') {
            document.getElementById('type-name').innerHTML = 'Followers';
        }

        // load-more button is dead, add it
        if (!document.getElementById('load-more')) {
            document.getElementById('top-box').innerHTML += `
            <div class="flex justify-center" id="load-more">
                <button class=" my-2 py-1.5 px-3 text-sm font-light bg-hsl-10
                    hover:bg-hsl-15 transition duration-200 rounded"
                    id="btn-loadmore" onclick="loadMore()">Load more</button>
            </div>`
        }
        reAddTippy();
    }

    function loadMore() {
        offset += 24;
        loadRelations(type, offset);
    }


    switchType('friend');
    reAddTippy();
</script>
{% endblock %}